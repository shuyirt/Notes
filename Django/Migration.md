# Migration 

Migrations are Django’s way of propagating changes you make to your models (adding a field, deleting a model, etc.) into your database schema.

## Commands

1. [`showmigrations`](https://docs.djangoproject.com/en/2.1/ref/django-admin/#django-admin-showmigrations), which lists a project’s migrations and their status.
2. [`makemigrations`](https://docs.djangoproject.com/en/2.1/ref/django-admin/#django-admin-makemigrations), which is responsible for creating new migrations based on the changes you have made to your models (e.g. add fields or remove a model)
3. [`migrate`](https://docs.djangoproject.com/en/2.1/ref/django-admin/#django-admin-migrate), which is responsible for applying and unapplying migrations.
4. [`sqlmigrate`](https://docs.djangoproject.com/en/2.1/ref/django-admin/#django-admin-sqlmigrate), which displays the SQL statements for a migration.

### makemigrations

1. run after you made changes to your models
2. `python manage.py makemigrations --name <$changed_my_model> <$your_app_label>`
3. models will be scanned and compared to the versions currently contained in your migration files, and then a new set of migrations will be written out

## data migrations

use migrations to change the data in the database itself, in conjunction with the schema if you want.

Migrations that alter data are usually called “data migrations”; they’re best written as separate migrations, sitting alongside your schema migrations.

1. making an empty migration file 

   `python manage.py makemigrations --empty yourappname`

2. Then, open up the file; it should look something like this:

   ```python
   # Generated by Django A.B on YYYY-MM-DD HH:MM
   from django.db import migrations
   
   class Migration(migrations.Migration):
   
       dependencies = [
           ('yourappname', '0001_initial'),
       ]
   
       operations = [
       ]
   ```

3. create a new function and have [`RunPython`](https://docs.djangoproject.com/en/2.1/ref/migration-operations/#django.db.migrations.operations.RunPython) use it

   [`RunPython`](https://docs.djangoproject.com/en/2.1/ref/migration-operations/#django.db.migrations.operations.RunPython) expects a callable as its argument which takes two arguments - the first is an [app registry](https://docs.djangoproject.com/en/2.1/ref/applications/) that has the historical versions of all your models loaded into it to match where in your history the migration sits, and the second is a [SchemaEditor](https://docs.djangoproject.com/en/2.1/ref/schema-editor/), which you can use to manually effect database schema changes (but beware, doing this can confuse the migration autodetector!)

   ```python
   from django.db import migrations
   
   def combine_names(apps, schema_editor):
       # We can't import the Person model directly as it may be a newer
       # version than this migration expects. We use the historical version.
       Person = apps.get_model('yourappname', 'Person')
       for person in Person.objects.all():
           person.name = '%s %s' % (person.first_name, person.last_name)
           person.save()
   
   class Migration(migrations.Migration):
   
       dependencies = [
           ('yourappname', '0001_initial'),
       ]
   
       operations = [
           migrations.RunPython(combine_names),
       ]
   ```

4. then run `python manage.py migrate`

   You can pass a second callable to [`RunPython`](https://docs.djangoproject.com/en/2.1/ref/migration-operations/#django.db.migrations.operations.RunPython) to run whatever logic you want executed when migrating backwards. If this callable is omitted, migrating backwards will raise an exception.

## Squashing migration 

Squashing is the act of reducing an existing set of many migrations down to one (or sometimes a few) migrations which still represent the same changes.

Django does this by taking all of your existing migrations, extracting their `Operation`s and putting them all in sequence, and then running an optimizer over them to try and reduce the length of the list - for example, it knows that [`CreateModel`](https://docs.djangoproject.com/en/2.1/ref/migration-operations/#django.db.migrations.operations.CreateModel) and [`DeleteModel`](https://docs.djangoproject.com/en/2.1/ref/migration-operations/#django.db.migrations.operations.DeleteModel) cancel each other out, and it knows that [`AddField`](https://docs.djangoproject.com/en/2.1/ref/migration-operations/#django.db.migrations.operations.AddField) can be rolled into [`CreateModel`](https://docs.djangoproject.com/en/2.1/ref/migration-operations/#django.db.migrations.operations.CreateModel).

run `python manage.py squashmigrations <app> <0004>  ` which squash migrations from 0001 to 0004

